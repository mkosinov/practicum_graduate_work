# Диплопная проектная работа: интеграция голосового ассистента с кинотеатром

Микросервис голосового помощника (assistant) принимает голосовые команды пользователя, обрабатывает их и трансформирует в поисковые запросы к микросервису с базой данных фильмов (movies), откуда получает результаты поиска и перенаправляет пользователю.

Схемы сервиса, а также диаграммы работы представлены в папке **/services/assistant/docs**

## Структура проекта

Структура проекта
/services
├── **assistant** - микросервис Ассистент
├──── assistant_api - API микросервиса
├──── docs - схемы микросервиса
├──── nginx - балансировщик нагрузки
├──── compose.yml - docker-compose файл для микросервиса Ассистент
├── **movies** - микросервис База данных фильмов (moviesAPI)
├──── elastic_data - БД Elasticsearch
├──── fastapi - API микросервиса
├──── nginx - балансировщик нагрузки
├──── tests - тесты микросервиса
├──── compose.yml - docker-compose файл для микросервиса moviesAPI
├── help.md - текстовое описание проекта
└── README.md - текущий файл

## Запуск микросервиса

### Создание сети

Необходимо предварительно создать в docker сеть **movies_project_net** с помощью команды:

```docker network create movies_project_net```

### Запуск сервиса moviesAPI с базой данных фильмов

Необходимо предварительно запустить микросервис movies и указать его hostname и port в конфигурационном файле /services/assistant/assistant_api/src/config.tom (по умолчанию: "movies.proxy", "80")

* Зайти в папку **services/movies** и выполнить команду:

```docker-compose up -d```

### Запуск MongoDB

Для работы сервиса необходимо предварительно настроить кластер MongoDB.

Порядок действий:

* Зайти в папку **services/assistant/mongo**, создать файл .env по примеру файла .env.example и выполнить команду:

```docker-compose up -d```

* Затем выполнить команду, которая выполнит первичную настройку кластера MongoDB:

```make mongo-config```

* Зайти в папку services/assistant/assistant_api/src/ и внести в файл config.toml данные для корректно работы с кластером MongoDB (пример приведен в том же файле).

После этого можно запускать сервис голосового помощника. При старте assistant.app произойдет инициализации БД и создание необходимых коллекций.

### Запуск сервиса голосового помощника

Для целей разработки запуск микросервиса следует сделать следующим образом:

1. запустить микросервис в папке **/services/assistant/**:

```docker compose up -d```

2. запустить в командной строке утилиту xTunnel[https://xtunnel.ru/], чтобы прокинуть локальный порт в интернет `./xTunnel 80`

Далее можно использовать существующий приватный навык Алисы (доступ открывается по одноразовой ссылке), либо создать новый навык.
Либо можно использовать swagger микросервиса Ассистента.

*Чтобы использовать существующий навык:*
3. Прислать сгенерированную ссылку на шаге 2. Разработчик публикует диалог с указанным адресом для webhook и после модерации навык разработчик присылает ссылку-приглашение на использование навыка через браузер или приложение Яндекс.
4. Все запросы от Алисы будут отправляться на указанный адрес

*Чтобы создать новый навык:*
3. Перейти на `https://dialogs.yandex.ru/`:
3.1. Консоль -> Создать диалог -> Навык в Алисе
3.2. Задать название навыка
3.3. В backend вставить адрес сгенерированный на шаге 2, с добалением `/webhook/alice`, к примеру `https://b3abe7f9-db93-4b89-9810-d21755f23997.tunnel4.com/webhook/alice`
3.4. Поставить галочку "Использовать хранилище данных в навыке"
3.5. Тип доступа = приватный
3.6. Примеры запросов = указать любой
3.7. Имя разработчика, Категория, Описание
3.8. Настройки -> Черновик -> Интенты
3.8.A:
    Добавить интенты из папки `/services/assistant/docs/yandex_dialogs_config/intents`.
    В ID необходимо вписать название файла, без ".yml"
    А содержимое yml файла полностью копируется в поле "Грамматика"
3.8.B:
    Добавить сущности из файла `/services/assistant/docs/yandex_dialogs_config/entities/entities.yml`
4. Перейти на вкладку тестирование. Навык должен ответить приветствием.
5. Для использования приватного навыка на колонке, необходимо опубликовать навык, тогда можно будет запустить его сказав фразу из пункта 3.6.

*Чтобы запустить swagger микросервиса:*
3. Перейти на `http://localhost/docs`
