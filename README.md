# Диплопная проектная работа: интеграция голосового ассистента с кинотеатром

Микросервис голосового помощника (assistant) принимает голосовые команды пользователя, обрабатывает их и трансформирует в поисковые запросы к микросервису с базой данных фильмов (movies), откуда получает результаты поиска и перенаправляет пользователю.

Схемы сервиса, а также диаграммы работы представлены в папке **/services/assistant/docs**

## Структура проекта

Структура проекта<br>
/services<br>
├── **assistant** - микросервис Ассистент<br>
├──── assistant_api - API микросервиса<br>
├──── docs - схемы микросервиса<br>
├──── nginx - балансировщик нагрузки<br>
├──── compose.yml - docker-compose файл для микросервиса Ассистент<br>
├── **movies** - микросервис База данных фильмов (moviesAPI)<br>
├──── elastic_data - БД Elasticsearch<br>
├──── fastapi - API микросервиса<br>
├──── nginx - балансировщик нагрузки<br>
├──── tests - тесты микросервиса<br>
├──── compose.yml - docker-compose файл для микросервиса moviesAPI<br>
├── help.md - текстовое описание проекта<br>
└── README.md - текущий файл<br>

## Запуск микросервиса

### Запуск сервиса moviesAPI с базой данных фильмов

Необходимо предварительно запустить микросервис movies и указать его hostname и port в конфигурационном файле /services/assistant/assistant_api/src/config.tom (по умолчанию: "movies.proxy", "80")

* Зайти в папку **services/movies** и выполнить команду:

```docker-compose up -d```

### Запуск MongoDB

Для работы сервиса необходимо предварительно настроить кластер MongoDB.

Порядок действий:

* Зайти в папку **services/assistant/mongo**, создать файл .env по примеру файла .env.example и выполнить команду:

```docker-compose up -d```

ВАЖНО! Чтобы MongoDB успешно поднялась, необходима docker сеть **movies_project_net**, в которой развернуты и все остальные сервисы.

* Затем выполнить команду, которая выполнит первичную настройку кластера MongoDB:

```make mongo-config```

* Зайти в папку services/assistant/assistant_api/src/ и внести в файл config.toml данные для корректно работы с кластером MongoDB (пример приведен в том же файле).

После этого можно запускать сервис голосового помощника. При старте assistant.app произойдет инициализации БД и создание необходимых коллекций.

### Запуск сервиса голосового помощника

Для целей разработки запуск микросервиса следует сделать следующим образом:

1. запустить микросервис в папке **/services/assistant/**:

```docker compose up -d```

2. запустить в командной строке утилиту xTunnel[https://xtunnel.ru/], чтобы прокинуть локальный порт в интернет `./xTunnel 80`

Далее можно использовать существующий приватный навык Алисы (доступ открывается по одноразовой ссылке), либо создать новый навык.
Либо можно использовать swagger микросервиса Ассистента.

*Чтобы использовать существующий навык:*<br>
3. Прислать сгенерированную ссылку на шаге 2. Разработчик публикует диалог с указанным адресом для webhook и после модерации навык разработчик присылает ссылку-приглашение на использование навыка через браузер или приложение Яндекс.<br>
4. Все запросы от Алисы будут отправляться на указанный адрес<br>

*Чтобы создать новый навык:*<br>
3. Перейти на `https://dialogs.yandex.ru/`:<br>
3.1. Консоль -> Создать диалог -> Навык в Алисе<br>
3.2. Задать название навыка<br>
3.3. В backend вставить адрес сгенерированный на шаге 2, с добалением `/webhook/alice`, к примеру `https://b3abe7f9-db93-4b89-9810-d21755f23997.tunnel4.com/webhook/alice`<br>
3.4. Поставить галочку "Использовать хранилище данных в навыке"<br>
3.5. Тип доступа = приватный<br>
3.6. Примеры запросов = указать любой<br>
3.7. Имя разработчика, Категория, Описание<br>
3.8. Настройки -> Черновик -> Интенты<br>
3.8.A:<br>
    Добавить интенты из папки `/services/assistant/docs/yandex_dialogs_config/intents`.<br>
    В ID необходимо вписать название файла, без ".yml"<br>
    А содержимое yml файла полностью копируется в поле "Грамматика"<br>
3.8.B:<br>
    Добавить сущности из файла `/services/assistant/docs/yandex_dialogs_config/entities/entities.yml`<br>
4. Перейти на вкладку тестирование. Навык должен ответить приветствием.<br>
5. Для использования приватного навыка на колонке, необходимо опубликовать навык, тогда можно будет запустить его сказав фразу из пункта 3.6.<br>

*Чтобы запустить swagger микросервиса:*<br>
3. Перейти на `http://localhost:8000/docs`<br>
